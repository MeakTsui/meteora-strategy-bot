# 🪐 Meteora DLMM 策略机器人

基于 Solana 上 Meteora DLMM（动态流动性做市商）协议的自动化做市机器人。本机器人实现了三种互补策略，在管理风险的同时最大化收益。

## 📋 目录

- [概述](#概述)
- [功能特性](#功能特性)
- [策略详解](#策略详解)
- [安装](#安装)
- [配置](#配置)
- [使用方法](#使用方法)
- [架构设计](#架构设计)
- [风险警告](#风险警告)
- [许可证](#许可证)

## 🎯 概述

本机器人管理一个 $5,000 USDC 的投资组合，通过三种自动化策略运作：

1. **Bid-Ask 高频策略（70% 资金）** - 主要利润来源
2. **趋势跟随策略（20% 资金）** - 捕捉强劲市场走势
3. **保险策略（10% 资金）** - 在市场崩盘时提供安全网

机器人在 SOL 价格区间 $100-$250 内运作，以 $5 为间隔划分。

## ✨ 功能特性

- 🔄 **多策略执行**：三种互补策略协同工作
- 📊 **实时价格监控**：多数据源兜底（Jupiter、Helius、Birdeye）
- 🛡️ **熔断保护**：连续失败后自动暂停交易
- 💰 **资金分配**：跨策略智能分配资金
- 📈 **回测模拟器**：使用历史数据测试策略
- 🧪 **Dry Run 模式**：无风险测试
- 📝 **详尽日志**：详细的执行日志和统计信息
- ⚡ **自动再平衡**：根据价格变动自动调整仓位

## 🎲 策略详解

### 1. Bid-Ask 高频策略（主策略 - 70%）

**目标**：通过频繁的仓位循环产生稳定收益

- 在 $5 价格区间内使用 SOL_ONLY 模式部署仓位
- 当价格突破区间上界（+ 0.3% 阈值）时：
  - 撤出仓位（捕获利润）
  - 在同一区间重新部署
  - 实现复利增长
- 通过频繁再平衡目标 20-35% APR

**示例**：
- 在 $140-$145 区间部署 1 SOL 仓位
- 价格上涨至 $145.50 → 撤出并重新部署
- 捕获约 3.9% 收益，准备下一轮循环

### 2. 趋势跟随策略（20%）

**目标**：利用强劲的方向性走势

- 在连续 3 次区间突破后激活
- **上涨趋势**：在上方区间部署 SOL_ONLY 仓位
- **下跌趋势**：在下方区间部署 USDC_ONLY 仓位
- 趋势反转时退出

**示例**：
- 价格连续突破 $140→$145→$150
- 机器人在 $155-$160 区间部署 SOL_ONLY 仓位
- 顺势而为，价格反转时退出

### 3. 保险策略（10%）

**目标**：从极端市场崩盘中获利

- 预定义"抄底"区间：$80-$100、$60-$80、$40-$60
- 仅在价格暴跌进入这些区间时激活
- 反弹 10%+ 后退出
- 在市场恐慌期间提供超额收益

**示例**：
- 价格从 $150 暴跌至 $75
- 机器人在 $60-$80 区间部署仓位
- 价格反弹至 $82.50 → 以 10% 利润退出

## 🚀 安装

### 前置要求

- Node.js 18+ 和 npm
- 带私钥的 Solana 钱包
- （可选）价格数据源的 API 密钥

### 安装步骤

```bash
# 克隆仓库
cd dlmm-strategy-bot

# 安装依赖
npm install

# 复制环境变量模板
cp .env.example .env

# 编辑配置
nano .env
```

## ⚙️ 配置

### 必需的环境变量

```bash
# Solana 配置
RPC_URL=https://api.mainnet-beta.solana.com
WALLET_PRIVATE_KEY=your_base58_private_key_here

# 资金与策略分配
TOTAL_CAPITAL_USDC=5000
MAIN_STRATEGY_ALLOCATION=0.70      # Bid-Ask
TREND_STRATEGY_ALLOCATION=0.20     # 趋势跟随
INSURANCE_STRATEGY_ALLOCATION=0.10 # 保险

# 价格区间
MIN_PRICE=100
MAX_PRICE=250
GRID_SIZE=5

# 策略参数
REDEPLOY_THRESHOLD=0.003           # 区间上方 0.3%
TREND_BREAKOUT_COUNT=3             # 连续突破次数
REBOUND_THRESHOLD=0.10             # 保险退出的 10% 反弹

# 机器人配置
CHECK_INTERVAL_MS=60000            # 每 60 秒检查一次
MAX_CONSECUTIVE_FAILURES=5         # 熔断器
ENABLE_DRY_RUN=true                # 以 dry run 模式启动
```

### 可选的 API 密钥

```bash
# 价格数据源（提高可靠性）
HELIUS_API_KEY=your_helius_key
BIRDEYE_API_KEY=your_birdeye_key
```

## 📖 使用方法

### 1. 运行模拟（推荐首先执行）

测试资金分配和仓位参数：

```bash
npm run simulate
```

输出：
- 跨策略的资金分配
- 仓位大小计算
- 样本仓位的预估 APR

### 2. 运行回测

使用历史数据测试策略：

```bash
npm run backtest
```

输出：
- 总交易次数和成功率
- 盈亏分析
- 最大回撤和年化收益
- 表现最佳的区间

### 3. 启动机器人（Dry Run）

测试机器人执行，不发送真实交易：

```bash
# 确保 .env 中 ENABLE_DRY_RUN=true
npm run start
```

### 4. 启动机器人（真实交易）

⚠️ **警告**：仅在充分测试后使用！

```bash
# 在 .env 中设置 ENABLE_DRY_RUN=false
npm run start
```

### 开发模式

```bash
npm run dev
```

## 🏗️ 架构设计

```
dlmm-strategy-bot/
├── src/
│   ├── config/
│   │   └── config.ts          # 配置管理
│   ├── core/
│   │   └── bot.ts             # 主机器人协调
│   ├── services/
│   │   ├── priceService.ts    # 多源价格数据
│   │   ├── rangeManager.ts    # 区间划分与跟踪
│   │   └── dlmmService.ts     # Meteora DLMM 接口
│   ├── strategies/
│   │   ├── bidAskStrategy.ts  # 主利润策略
│   │   ├── trendStrategy.ts   # 趋势跟随
│   │   └── insuranceStrategy.ts # 安全网
│   ├── types/
│   │   └── index.ts           # TypeScript 类型定义
│   ├── utils/
│   │   ├── logger.ts          # Winston 日志
│   │   └── helpers.ts         # 工具函数
│   ├── index.ts               # 入口点
│   ├── backtest.ts            # 回测引擎
│   └── simulate.ts            # 仓位模拟器
├── logs/                      # 执行日志
├── .env.example               # 环境变量模板
├── package.json
├── tsconfig.json
└── README.md
```

### 核心组件

**价格服务（Price Service）**：
- 从多个数据源获取 SOL 价格
- 失败时自动兜底
- 实时价格订阅

**区间管理器（Range Manager）**：
- 将 $100-$250 划分为 $5 区间
- 跟踪当前价格区间
- 检测突破

**DLMM 服务（DLMM Service）**：
- 与 Meteora 协议交互
- 创建/撤出仓位
- 处理交易签名

**策略模块（Strategies）**：
- 独立策略执行
- 仓位生命周期管理
- 盈亏跟踪

**机器人协调器（Bot Coordinator）**：
- 按计划执行策略
- 熔断器保护
- 详尽日志记录

## ⚠️ 风险警告

### 财务风险

1. **无常损失**：LP 仓位在价格变动期间会产生无常损失
2. **市场风险**：加密货币价格高度波动
3. **智能合约风险**：Meteora 协议可能存在漏洞
4. **滑点**：大额仓位可能遭受价格冲击
5. **Gas 费用**：交易成本会降低净利润

### 技术风险

1. **RPC 故障**：连接问题可能错失机会
2. **价格数据延迟**：过时价格导致错误决策
3. **交易失败**：失败的交易浪费手续费
4. **MEV/抢跑**：机器人可能抢跑你的交易

### 操作风险

1. **配置错误**：错误的参数 = 损失
2. **资金不足**：小额仓位收益微薄
3. **私钥安全**：私钥泄露 = 全部损失
4. **无止损**：机器人在不利条件下继续交易

### 建议

✅ **应该做的**：
- 从 dry run 模式开始
- 先用小额资金测试
- 定期监控日志
- 保护好私钥
- 大额资金使用硬件钱包

❌ **不应该做的**：
- 使用无法承受损失的资金
- 让机器人无人看管数天
- 忽略错误信息
- 分享你的私钥
- 未经测试就部署

## 📊 预期表现

基于回测（不保证）：

- **Bid-Ask 策略**：20-35% APR
- **趋势策略**：15-40% APR（可变）
- **保险策略**：0-100% APR（事件驱动）
- **整体目标**：25-35% APR
- **最大回撤**：10-15%

实际结果取决于市场条件、执行质量和运气。

## 🔧 故障排查

### 常见问题

**1. "Failed to get price"（获取价格失败）**
- 检查 RPC_URL 连接性
- 验证 API 密钥有效
- 检查网络连接

**2. "Circuit breaker tripped"（熔断器触发）**
- 查看错误日志
- 检查钱包余额
- 验证仓位限制

**3. "Insufficient capital"（资金不足）**
- 增加 TOTAL_CAPITAL_USDC
- 减少活跃仓位数量
- 调整分配百分比

**4. 交易失败**
- 增加 RPC 超时时间
- 检查钱包 SOL 余额（用于手续费）
- 验证池子流动性

### 日志

查看 `logs/` 目录中的每日日志：
```bash
tail -f logs/$(date +%Y-%m-%d).log
```

## 🤝 贡献

这是一个个人项目。欢迎 fork 并根据你的需求修改。

## 📄 许可证

MIT License - 使用风险自负

## ⚖️ 免责声明

本软件按"原样"提供，不提供任何保证。作者对任何财务损失不承担责任。加密货币交易存在重大风险。仅投资你能承受损失的资金。

**这不是财务建议。请自行研究。**

---

用 ☄️ 为 Meteora DLMM 制作

**祝交易愉快！🚀**
